<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorveteria Del√≠cia Online üç¶</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --cor-primaria: #FFC0CB; --cor-secundaria: #FFB6C1; --cor-texto: #333; --cor-branca: #fff; --cor-destaque: #FF69B4; --cor-sucesso: #4CAF50; --cor-aviso: #FF9800; --cor-erro: #F44336; --sombra-suave: 0 2px 8px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; background-color: #FFF0F5; color: var(--cor-texto); display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; width: 95%; }
        header { background-color: var(--cor-primaria); padding: 1rem 0; box-shadow: var(--sombra-suave); position: sticky; top: 0; z-index: 999; }
        header .container { display: flex; justify-content: space-between; align-items: center; }
        header h1 { color: var(--cor-destaque); font-weight: 700; font-size: 1.8rem; }
        #carrinho-icon-header { font-size: 1.5rem; cursor: pointer; position: relative; background-color: var(--cor-branca); padding: 8px 12px; border-radius: 50px; box-shadow: var(--sombra-suave); color: var(--cor-destaque); display: flex; align-items: center; }
        #carrinho-icon-header .cart-emoji { margin-right: 5px; }
        #contador-carrinho-header { background-color: var(--cor-destaque); color: var(--cor-branca); border-radius: 50%; padding: 0.2em 0.5em; font-size: 0.8rem; font-weight: 600; position: absolute; top: -8px; right: -8px; }

        #cep-section { background-color: var(--cor-secundaria); padding: 1.5rem 0; text-align: center; }
        #cep-section h2 { margin-bottom: 1rem; color: var(--cor-texto); }
        #cliente-nome-group input[type="text"] { width: calc(100% - 22px); max-width: 400px; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px; font-family: 'Poppins', sans-serif; margin: 0 auto 1rem auto; display: block;}
        #cep-input-group { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; gap: 0.5rem; flex-wrap: wrap;}
        #cep-input-group input[type="text"] { padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px; width: 200px; font-family: 'Poppins', sans-serif; }
        #cep-input-group button { padding: 0.7rem 1rem; background-color: var(--cor-destaque); color: var(--cor-branca); border: none; border-radius: 5px; cursor: pointer; font-family: 'Poppins', sans-serif; transition: background-color 0.3s ease; }
        #cep-input-group button:hover { background-color: #FF1493; }
        #cep-resultado { margin-top: 0.5rem; margin-bottom:1rem; font-weight: 600; min-height: 20px; }
        #cep-resultado.sucesso { color: var(--cor-sucesso); } #cep-resultado.aviso { color: var(--cor-aviso); } #cep-resultado.erro { color: var(--cor-erro); }
        #endereco-completo-form { background-color: #fff5f7; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-width: 500px; margin-left: auto; margin-right: auto;}
        #endereco-completo-form h3 { color: var(--cor-destaque); margin-bottom: 1rem; font-size: 1.2rem; }
        #endereco-completo-form input[type="text"] { display: block; width: 100%; padding: 0.8rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 5px; font-family: 'Poppins', sans-serif; }
        #endereco-completo-form input[readonly] { background-color: #f0f0f0; cursor: not-allowed; }
        #endereco-completo-form button { display: block; width: 100%; padding: 0.9rem; margin: 1rem 0 0.5rem; background-color: var(--cor-sucesso); color: var(--cor-branca); border: none; border-radius: 5px; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; transition: background-color 0.3s ease; }
        #endereco-completo-form button:hover { background-color: #45a049; }
        #endereco-confirmado-msg { margin-top: 0.5rem; font-weight: 600; color: var(--cor-sucesso); }

        .busca-container { margin: 1.5rem 0 2rem 0; text-align: center; }
        #input-busca-produto { padding: 0.8rem 1rem; width: 80%; max-width: 450px; border: 1px solid #ddd; border-radius: 25px; font-family: 'Poppins', sans-serif; font-size: 1rem; box-shadow: var(--sombra-suave); }
        #input-busca-produto:focus { border-color: var(--cor-destaque); outline-color: var(--cor-destaque); }

        .categorias { text-align: center; margin: 2.5rem 0; }
        .categorias h2 { margin-bottom: 1.5rem; color: var(--cor-texto); }
        .categorias button { padding: 0.8rem 1.5rem; margin: 0.5rem; border: 1px solid var(--cor-destaque); background-color: var(--cor-branca); color: var(--cor-destaque); border-radius: 25px; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; transition: background-color 0.3s ease, color 0.3s ease; }
        .categorias button:hover, .categorias button.active { background-color: var(--cor-destaque); color: var(--cor-branca); }
        
        #lista-produtos { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; padding-bottom: 2rem; }
        .produto { background-color: var(--cor-branca); border-radius: 10px; box-shadow: var(--sombra-suave); padding: 1rem; text-align: center; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s ease-in-out, opacity 0.3s ease; }
        .produto:hover { transform: translateY(-5px); }
        .produto img { max-width: 100%; width: 100%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 0.8rem; background-color: #f0f0f0; }
        .produto h3 { margin-bottom: 0.4rem; font-size: 1.25rem; color: var(--cor-texto); min-height: 2.5em; }
        .produto .preco { font-size: 1.1rem; color: var(--cor-destaque); font-weight: 600; margin-bottom: 0.8rem; }
        .quantidade-produto-controle { display: flex; align-items: center; justify-content: center; margin-bottom: 0.8rem; }
        .quantidade-produto-controle button { background-color: #f0f0f0; border: 1px solid #ccc; color: var(--cor-texto); width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; line-height: 28px; padding:0; display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
        .quantidade-produto-controle button:hover { background-color: #e0e0e0; }
        .quantidade-produto-controle .input-qtd-produto { width: 40px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 0.3rem; margin: 0 0.5rem; font-family: 'Poppins'; font-weight: 600; -moz-appearance: textfield; appearance: textfield; }
        .quantidade-produto-controle .input-qtd-produto::-webkit-outer-spin-button,
        .quantidade-produto-controle .input-qtd-produto::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .produto .adicionar { padding: 0.6rem 0.8rem; background-color: var(--cor-destaque); color: var(--cor-branca); border: none; border-radius: 5px; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; transition: background-color 0.3s ease; margin-top: auto; font-size: 0.9rem; width: 100%; }
        .produto .adicionar:hover { background-color: #FF1493; }
        
        #popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--cor-sucesso); color: var(--cor-branca); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2001; text-align: center; transition: opacity 0.5s ease-out, top 0.5s ease-out; }
        #popup.escondido { opacity: 0; top: -100px; pointer-events: none; }
        #popup p { font-size: 1.1rem; margin: 0; font-weight: 600; }

        .produto.escondido { display: none !important; opacity: 0; } 
        .escondido { display: none !important; }

        .modal-carrinho-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-carrinho-overlay.ativo { opacity: 1; visibility: visible; }
        #modal-carrinho { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); background-color: var(--cor-branca); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 600px; max-height: 90vh; z-index: 2000; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease; }
        #modal-carrinho:not(.escondido) { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #eee; background-color: var(--cor-primaria); }
        .modal-header h2 { margin: 0; color: var(--cor-destaque); font-size: 1.4rem; }
        .fechar-modal { background: none; border: none; font-size: 2rem; color: var(--cor-destaque); cursor: pointer; line-height: 1; }
        #itens-carrinho-lista-modal { flex-grow: 1; overflow-y: auto; padding: 0.5rem 1.5rem; }
        #itens-carrinho-lista-modal .item-carrinho { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        #itens-carrinho-lista-modal .item-carrinho:last-child { border-bottom: none; }
        .item-carrinho-nome { flex-basis: 40%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .item-carrinho-qtd-controle { display: flex; align-items: center; justify-content: center; flex-basis: 30%; }
        .item-carrinho-qtd-controle button.btn-qtd { background-color: #f0f0f0; border: 1px solid #ccc; color: var(--cor-texto); width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; line-height: 24px; padding:0; display:flex; align-items:center; justify-content:center; font-size:1rem; }
        .item-carrinho-qtd-controle button.btn-qtd:hover { background-color: #e0e0e0; }
        .item-carrinho-qtd-controle .qtd-valor { padding: 0 10px; min-width: 20px; text-align: center; font-weight: 600;}
        .item-carrinho-preco { font-weight: 600; min-width: 65px; text-align: right; flex-basis: 20%; }
        .item-carrinho-remover { background-color: #ffebee; color: var(--cor-erro); border: 1px solid #ffcdd2; border-radius: 50%; width: 26px; height: 26px; line-height: 24px; text-align: center; cursor: pointer; font-size: 1.1rem; margin-left: 8px; transition: background-color 0.2s; }
        .item-carrinho-remover:hover { background-color: #ffcdd2; }
        .cupom-container { padding: 1rem 1.5rem 0; display: flex; gap: 0.5rem; align-items: center; }
        .cupom-container input[type="text"] { flex-grow: 1; padding: 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-family: 'Poppins'; }
        .cupom-container button { padding: 0.6rem 1rem; background-color: var(--cor-destaque); color: white; border:none; border-radius:4px; cursor:pointer; }
        #cupom-feedback { font-size: 0.85rem; margin-top: 0.5rem; padding: 0 1.5rem; min-height: 1.2em; }
        #cupom-feedback.sucesso { color: var(--cor-sucesso); } #cupom-feedback.erro { color: var(--cor-erro); } #cupom-feedback.aviso {color: var(--cor-aviso);}
        .desconto-info { font-size: 0.9rem; color: var(--cor-sucesso); text-align: right; padding-right: 1.5rem;}
        .modal-footer { padding: 1.5rem; border-top: 1px solid #eee; background-color: #fdfdfd; }
        #carrinho-total-modal { text-align: right; font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; color: var(--cor-texto); }
        #carrinho-total-modal span { color: var(--cor-destaque); }
        .carrinho-acoes-modal { display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .carrinho-acoes-modal button { padding: 0.9rem; border-radius: 5px; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; border: none; font-size: 1rem; transition: background-color 0.3s ease; flex-basis: 100%; }
        .carrinho-acoes-modal .continuar-comprando, .carrinho-acoes-modal .limpar-carrinho-btn { background-color: #e0e0e0; color: var(--cor-texto); }
        .carrinho-acoes-modal .continuar-comprando:hover, .carrinho-acoes-modal .limpar-carrinho-btn:hover { background-color: #d0d0d0; }
        .carrinho-acoes-modal .finalizar-pedido { background-color: var(--cor-sucesso); color: var(--cor-branca); }
        .carrinho-acoes-modal .finalizar-pedido:hover { background-color: #45a049; }
        .carrinho-acoes-modal .finalizar-pedido:disabled { background-color: #a5d6a7; cursor: not-allowed; }

        @media (min-width: 480px) {
            .carrinho-acoes-modal .continuar-comprando, .carrinho-acoes-modal .limpar-carrinho-btn { flex-basis: calc(50% - 0.5rem); }
            .carrinho-acoes-modal .finalizar-pedido { flex-basis: 100%; margin-top: 0.5rem; }
        }

        #ultimos-pedidos-section { padding: 2rem 0; background-color: #fffafb; }
        #ultimos-pedidos-section h2 { text-align: center; color: var(--cor-destaque); margin-bottom: 1.5rem; }
        .lista-ultimos-pedidos { max-width: 700px; margin: 0 auto; }
        .pedido-anterior { background-color: white; border: 1px solid #eee; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: var(--sombra-suave); }
        .pedido-anterior-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .pedido-anterior-header span { font-size: 0.9rem; color: #777; }
        .pedido-anterior-header strong { font-size: 1.1rem; color: var(--cor-texto); }
        .pedido-anterior-itens { font-size: 0.9rem; margin-left: 1rem; margin-bottom: 0.5rem; color: #555; list-style: disc; padding-left: 1rem;}
        .pedido-anterior .btn-repetir-pedido { display: block; width: auto; padding: 0.5rem 1rem; background-color: var(--cor-destaque); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem; transition: background-color 0.2s; }
        .pedido-anterior .btn-repetir-pedido:hover { background-color: #FF1493; }
        #sem-pedidos-anteriores {text-align: center; color: #777;}

        footer { background-color: var(--cor-primaria); color: var(--cor-destaque); text-align: center; padding: 1rem 0; margin-top: auto; }
        
        @media (max-width: 768px) {
            #lista-produtos { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;}
            .produto { padding: 0.8rem; } .produto img { height: 150px; } .produto h3 { font-size: 1.1rem; } .produto .preco { font-size: 1rem; } .produto .adicionar { padding: 0.5rem 0.7rem; font-size: 0.85rem;}
            #modal-carrinho { max-width: 95%; } 
        }
        @media (max-width: 480px) {
            header h1 { font-size: 1.5rem; }
            #cliente-nome-group input[type="text"] { width: 100%;}
            #cep-input-group input[type="text"] { width: 100%; margin-bottom: 0.5rem; } #cep-input-group button { width: 100%; }
            #input-busca-produto {width: 95%;}
            #endereco-completo-form {padding: 1rem;} #endereco-completo-form input[type="text"], #endereco-completo-form button { width: 100%; margin-left:0; margin-right:0;}
            #lista-produtos { grid-template-columns: 1fr; }
            .carrinho-acoes-modal { flex-direction: column;}
            .carrinho-acoes-modal button { flex-basis: auto !important; margin-top: 0.5rem;}
            .item-carrinho-nome { flex-basis: 40%; font-size: 0.85rem;}
            .item-carrinho-qtd-controle { flex-basis: 35%;}
            .cupom-container { flex-direction: column; align-items: stretch;}
            .cupom-container input[type="text"] { margin-bottom: 0.5rem;}
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üç¶ Sorveteria Del√≠cia</h1>
            <div id="carrinho-icon-header" title="Ver carrinho">
                <span class="cart-emoji">üõí</span>
                <span id="contador-carrinho-header">0</span>
            </div>
        </div>
    </header>

    <section id="cep-section">
        <div class="container">
            <h2>üìç Endere√ßo para Entrega</h2>
            <div id="cliente-nome-group"> <input type="text" id="cliente-nome" placeholder="Seu nome completo *" /> </div>
            <div id="cep-input-group"> <input type="text" id="cep" placeholder="Seu CEP (s√≥ n√∫meros)" maxlength="8" /> <button id="btn-verificar-cep" onclick="validarEPreencherEndereco()">Verificar CEP</button> </div>
            <div id="cep-resultado"></div>
            <div id="endereco-completo-form" class="escondido">
                <h3>Complete seu endere√ßo:</h3>
                <input type="text" id="endereco-rua" placeholder="Rua / Avenida" readonly /> <input type="text" id="endereco-numero" placeholder="N√∫mero *" required /> <input type="text" id="endereco-complemento" placeholder="Complemento (Apto, Bloco, Ponto de Ref.)" /> <input type="text" id="endereco-bairro" placeholder="Bairro" readonly /> <input type="text" id="endereco-cidade" placeholder="Cidade" readonly /> <input type="text" id="endereco-uf" placeholder="UF" readonly />
                <button id="btn-confirmar-endereco" onclick="confirmarEnderecoCompleto()">Confirmar Endere√ßo</button>
                <div id="endereco-confirmado-msg"></div>
            </div>
        </div>
    </section>

    <main class="container">
        <section class="busca-container"> <input type="text" id="input-busca-produto" placeholder="üîé Buscar pelo nome do sorvete..."> </section>
        <section class="categorias">
            <h2>Nossas Del√≠cias üç®</h2>
            <button data-categoria="todos" class="active">Todos</button> <button data-categoria="copos">Copos</button> <button data-categoria="potes">Potes</button> <button data-categoria="picoles">Picol√©s</button>
        </section>
        <section id="lista-produtos">
            <div class="produto" data-categoria="copos" data-nome="Copo Morango Cremoso" data-preco="10.00">
                <img src="https://picsum.photos/seed/copomorangocremoso/300/200" alt="Copo de Morango Cremoso" />
                <h3>Copo Morango Cremoso</h3><p class="preco">R$ 10,00</p>
                <div class="quantidade-produto-controle"><button class="btn-qtd-produto-menos" type="button">-</button><input type="number" class="input-qtd-produto" value="1" min="1" max="99" readonly><button class="btn-qtd-produto-mais" type="button">+</button></div>
                <button class="adicionar">Adicionar</button>
            </div>
            <div class="produto" data-categoria="potes" data-nome="Pote Fam√≠lia Chocolate" data-preco="25.00">
                <img src="https://picsum.photos/seed/potefamiliachocolate/300/200" alt="Pote Fam√≠lia Chocolate" />
                <h3>Pote Fam√≠lia Chocolate</h3><p class="preco">R$ 25,00</p>
                <div class="quantidade-produto-controle"><button class="btn-qtd-produto-menos" type="button">-</button><input type="number" class="input-qtd-produto" value="1" min="1" max="99" readonly><button class="btn-qtd-produto-mais" type="button">+</button></div>
                <button class="adicionar">Adicionar</button>
            </div>
            <div class="produto" data-categoria="picoles" data-nome="Picol√© Lim√£o Siciliano" data-preco="5.00">
                <img src="https://picsum.photos/seed/picolelimaosiciliano/300/200" alt="Picol√© Lim√£o Siciliano" />
                <h3>Picol√© Lim√£o Siciliano</h3><p class="preco">R$ 5,00</p>
                <div class="quantidade-produto-controle"><button class="btn-qtd-produto-menos" type="button">-</button><input type="number" class="input-qtd-produto" value="1" min="1" max="99" readonly><button class="btn-qtd-produto-mais" type="button">+</button></div>
                <button class="adicionar">Adicionar</button>
            </div>
            <div class="produto" data-categoria="copos" data-nome="Copo A√ßa√≠ com Banana" data-preco="12.00">
                <img src="https://picsum.photos/seed/copoacaicombanana/300/200" alt="Copo A√ßa√≠ com Banana" />
                <h3>Copo A√ßa√≠ com Banana</h3><p class="preco">R$ 12,00</p>
                <div class="quantidade-produto-controle"><button class="btn-qtd-produto-menos" type="button">-</button><input type="number" class="input-qtd-produto" value="1" min="1" max="99" readonly><button class="btn-qtd-produto-mais" type="button">+</button></div>
                <button class="adicionar">Adicionar</button>
            </div>
            <div class="produto" data-categoria="potes" data-nome="Pote Napolitano Especial" data-preco="28.00">
                <img src="https://picsum.photos/seed/potenapolitanoespecial/300/200" alt="Pote Napolitano Especial" />
                <h3>Pote Napolitano Especial</h3><p class="preco">R$ 28,00</p>
                <div class="quantidade-produto-controle"><button class="btn-qtd-produto-menos" type="button">-</button><input type="number" class="input-qtd-produto" value="1" min="1" max="99" readonly><button class="btn-qtd-produto-mais" type="button">+</button></div>
                <button class="adicionar">Adicionar</button>
            </div>
            <div class="produto" data-categoria="picoles" data-nome="Picol√© Uva Refrescante" data-preco="4.50">
                <img src="https://picsum.photos/seed/picoleuvaresfrescante/300/200" alt="Picol√© Uva Refrescante" />
                <h3>Picol√© Uva Refrescante</h3><p class="preco">R$ 4,50</p>
                <div class="quantidade-produto-controle"><button class="btn-qtd-produto-menos" type="button">-</button><input type="number" class="input-qtd-produto" value="1" min="1" max="99" readonly><button class="btn-qtd-produto-mais" type="button">+</button></div>
                <button class="adicionar">Adicionar</button>
            </div>
        </section>
    </main>
    
    <section id="ultimos-pedidos-section" class="container">
        <h2>Seus √öltimos Pedidos</h2>
        <div id="lista-ultimos-pedidos-container">
            <p id="sem-pedidos-anteriores">Voc√™ ainda n√£o tem pedidos recentes.</p>
        </div>
    </section>

    <div id="popup" class="escondido"><p id="popup-mensagem">Item adicionado ao carrinho!</p></div>

    <div id="modal-carrinho-overlay" class="modal-carrinho-overlay escondido" onclick="fecharModalCarrinho()"></div>
    <div id="modal-carrinho" class="escondido">
        <div class="modal-header"> <h2>üõí Seu Carrinho</h2> <button class="fechar-modal" onclick="fecharModalCarrinho()" title="Fechar carrinho">√ó</button> </div>
        <div id="itens-carrinho-lista-modal"> <p style="text-align: center; padding: 20px 0;">Seu carrinho est√° vazio.</p> </div>
        <div class="cupom-container"> <input type="text" id="input-cupom" placeholder="C√≥digo do cupom"> <button id="btn-aplicar-cupom" onclick="aplicarCupom()">Aplicar</button> </div>
        <p id="cupom-feedback"></p> <p class="desconto-info" id="desconto-aplicado-info"></p>
        <div class="modal-footer">
            <div id="carrinho-total-modal"> <strong>Total: R$ <span id="total-preco-carrinho-modal">0,00</span></strong> </div>
            <div class="carrinho-acoes-modal">
                <button class="continuar-comprando" onclick="fecharModalCarrinho()">Continuar Comprando</button>
                <button class="limpar-carrinho-btn" onclick="limparCarrinhoCompleto()">Limpar Carrinho</button>
                <button id="finalizar-pedido-whatsapp-modal" class="finalizar-pedido">Finalizar Pedido via WhatsApp</button>
            </div>
        </div>
    </div>
    <footer><div class="container"><p>¬© 2025 Sorveteria Del√≠cia. Todos os direitos reservados.</p></div></footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contadorCarrinhoHeaderEl = document.getElementById('contador-carrinho-header');
            const carrinhoIconHeaderEl = document.getElementById('carrinho-icon-header');
            const modalCarrinhoEl = document.getElementById('modal-carrinho');
            const modalCarrinhoOverlayEl = document.getElementById('modal-carrinho-overlay');
            const itensCarrinhoListaModalEl = document.getElementById('itens-carrinho-lista-modal');
            const totalPrecoCarrinhoModalEl = document.getElementById('total-preco-carrinho-modal');
            const btnFinalizarPedidoWhatsAppModal = document.getElementById('finalizar-pedido-whatsapp-modal');
            const popupEl = document.getElementById('popup');
            const popupMensagemEl = document.getElementById('popup-mensagem');
            const botoesAdicionar = document.querySelectorAll('.adicionar');
            const botoesCategoria = document.querySelectorAll('.categorias button');
            const produtosEl = document.querySelectorAll('.produto');
            const clienteNomeEl = document.getElementById('cliente-nome');
            const cepInputEl = document.getElementById('cep');
            const cepResultadoEl = document.getElementById('cep-resultado');
            const enderecoCompletoFormEl = document.getElementById('endereco-completo-form');
            const enderecoRuaEl = document.getElementById('endereco-rua');
            const enderecoNumeroEl = document.getElementById('endereco-numero');
            const enderecoComplementoEl = document.getElementById('endereco-complemento');
            const enderecoBairroEl = document.getElementById('endereco-bairro');
            const enderecoCidadeEl = document.getElementById('endereco-cidade');
            const enderecoUfEl = document.getElementById('endereco-uf');
            const enderecoConfirmadoMsgEl = document.getElementById('endereco-confirmado-msg');
            const inputBuscaProdutoEl = document.getElementById('input-busca-produto');
            const inputCupomEl = document.getElementById('input-cupom');
            const cupomFeedbackEl = document.getElementById('cupom-feedback');
            const descontoAplicadoInfoEl = document.getElementById('desconto-aplicado-info');
            const listaUltimosPedidosContainerEl = document.getElementById('lista-ultimos-pedidos-container');
            const semPedidosAnterioresEl = document.getElementById('sem-pedidos-anteriores');

            let itensNoCarrinho = 0; 
            let carrinhoItensDetalhes = []; 
            let enderecoEntregaInfo = null;
            let popupTimeout;
            let cupomAplicado = null;
            let ultimosPedidos = [];
            const MAX_ULTIMOS_PEDIDOS = 3;

            const CUPONS_VALIDOS = { "SORVETE10": { tipo: "percentual", valor: 10 }, "OFF5": { tipo: "fixo", valor: 5 }, "CLIENTEVIP": { tipo: "percentual", valor: 15 } };
            
            function salvarDadosClienteNoLocalStorage() {
                localStorage.setItem('sorveteriaCarrinhoItens', JSON.stringify(carrinhoItensDetalhes));
                localStorage.setItem('sorveteriaItensNoCarrinho', itensNoCarrinho.toString());
                if (clienteNomeEl.value.trim()) localStorage.setItem('sorveteriaNomeCliente', clienteNomeEl.value.trim());
                if (enderecoEntregaInfo) localStorage.setItem('sorveteriaEnderecoEntrega', enderecoEntregaInfo); else localStorage.removeItem('sorveteriaEnderecoEntrega');
                if (cupomAplicado) localStorage.setItem('sorveteriaCupomAplicado', JSON.stringify(cupomAplicado)); else localStorage.removeItem('sorveteriaCupomAplicado');
                localStorage.setItem('sorveteriaUltimosPedidos', JSON.stringify(ultimosPedidos));
            }

            function carregarDadosDoLocalStorage() {
                const carrinhoSalvo = localStorage.getItem('sorveteriaCarrinhoItens');
                const itensNoCarrinhoSalvo = localStorage.getItem('sorveteriaItensNoCarrinho');
                const nomeSalvo = localStorage.getItem('sorveteriaNomeCliente');
                const enderecoSalvo = localStorage.getItem('sorveteriaEnderecoEntrega');
                const cupomSalvo = localStorage.getItem('sorveteriaCupomAplicado');
                const ultimosPedidosSalvos = localStorage.getItem('sorveteriaUltimosPedidos');

                if (carrinhoSalvo) carrinhoItensDetalhes = JSON.parse(carrinhoSalvo);
                if (itensNoCarrinhoSalvo) itensNoCarrinho = parseInt(itensNoCarrinhoSalvo, 10) || 0;
                if (nomeSalvo) clienteNomeEl.value = nomeSalvo;
                if (enderecoSalvo) { enderecoEntregaInfo = enderecoSalvo; enderecoConfirmadoMsgEl.textContent = "Usaremos o √∫ltimo nome e endere√ßo informados."; enderecoConfirmadoMsgEl.style.display = 'block'; }
                if (cupomSalvo) cupomAplicado = JSON.parse(cupomSalvo);
                if (ultimosPedidosSalvos) ultimosPedidos = JSON.parse(ultimosPedidosSalvos);
                
                atualizarContadorCarrinho();
                renderizarUltimosPedidos();
            }

            function atualizarContadorCarrinho() { 
                console.log("Atualizando contador para:", itensNoCarrinho);
                if(contadorCarrinhoHeaderEl) contadorCarrinhoHeaderEl.textContent = itensNoCarrinho;
            }
            
            function mostrarPopup(mensagem, tipo = 'sucesso') {
                console.log("Mostrando Popup:", mensagem, "Tipo:", tipo);
                popupMensagemEl.textContent = mensagem;
                popupEl.style.backgroundColor = tipo === 'erro' ? 'var(--cor-erro)' : tipo === 'aviso' ? 'var(--cor-aviso)' : 'var(--cor-sucesso)';
                popupEl.classList.remove('escondido');
                popupEl.style.opacity = '1'; popupEl.style.top = '20px';
                if (popupTimeout) clearTimeout(popupTimeout);
                popupTimeout = setTimeout(() => { fecharPopup(); }, 3000);
            }
            window.fecharPopup = function() { popupEl.style.opacity = '0'; popupEl.style.top = '-100px'; setTimeout(() => { popupEl.classList.add('escondido'); }, 500); if (popupTimeout) clearTimeout(popupTimeout); }
            
            window.abrirModalCarrinho = function() { renderizarCarrinhoModal(); modalCarrinhoOverlayEl.classList.remove('escondido'); modalCarrinhoOverlayEl.classList.add('ativo'); modalCarrinhoEl.classList.remove('escondido'); document.body.style.overflow = 'hidden'; }
            window.fecharModalCarrinho = function() { modalCarrinhoOverlayEl.classList.add('escondido'); modalCarrinhoOverlayEl.classList.remove('ativo'); modalCarrinhoEl.classList.add('escondido'); document.body.style.overflow = ''; }
            
            function formatarPreco(valor) { return valor.toFixed(2).replace('.', ','); }

            function aplicarFiltrosProdutos() {
                const categoriaAtivaEl = document.querySelector('.categorias button.active');
                const categoriaSelecionada = categoriaAtivaEl ? categoriaAtivaEl.dataset.categoria : 'todos';
                const termoBusca = inputBuscaProdutoEl.value.toLowerCase().trim();
                produtosEl.forEach(produto => {
                    const nomeProdutoH3 = produto.querySelector('h3');
                    if (!nomeProdutoH3) return; 
                    const nomeProduto = nomeProdutoH3.textContent.toLowerCase();
                    const categoriaProduto = produto.dataset.categoria;
                    const atendeCategoria = (categoriaSelecionada === 'todos' || categoriaProduto === categoriaSelecionada);
                    const atendeBusca = (termoBusca === '' || nomeProduto.includes(termoBusca));
                    produto.classList.toggle('escondido', !(atendeCategoria && atendeBusca));
                });
            }

            window.aplicarCupom = function() {
                const codigoDigitado = inputCupomEl.value.trim().toUpperCase();
                cupomFeedbackEl.textContent = ''; cupomFeedbackEl.className = '';
                if (!codigoDigitado) { cupomFeedbackEl.textContent = "Digite um c√≥digo."; cupomFeedbackEl.classList.add('aviso'); return; }
                const cupomInfo = CUPONS_VALIDOS[codigoDigitado];
                if (cupomInfo) { cupomAplicado = { ...cupomInfo, codigo: codigoDigitado }; cupomFeedbackEl.textContent = `Cupom "${codigoDigitado}" aplicado!`; cupomFeedbackEl.classList.add('sucesso'); inputCupomEl.value = ''; }
                else { cupomAplicado = null; cupomFeedbackEl.textContent = "Cupom inv√°lido."; cupomFeedbackEl.classList.add('erro'); }
                renderizarCarrinhoModal(); 
                salvarDadosClienteNoLocalStorage();
            }

            function renderizarCarrinhoModal() {
                console.log("[RENDERIZAR MODAL] Iniciando. Itens:", JSON.stringify(carrinhoItensDetalhes), "Cupom:", JSON.stringify(cupomAplicado));
                itensCarrinhoListaModalEl.innerHTML = ''; 
                let subTotalItens = 0;
                descontoAplicadoInfoEl.textContent = '';

                if (carrinhoItensDetalhes.length === 0) {
                    console.log("[RENDERIZAR MODAL] Carrinho VAZIO.");
                    itensCarrinhoListaModalEl.innerHTML = '<p style="text-align: center; padding: 20px 0;">Seu carrinho est√° vazio!</p>';
                    totalPrecoCarrinhoModalEl.textContent = '0,00';
                    btnFinalizarPedidoWhatsAppModal.disabled = true; 
                    cupomAplicado = null; 
                    descontoAplicadoInfoEl.textContent = ''; 
                    cupomFeedbackEl.textContent = '';
                    inputCupomEl.value = '';
                    console.log("[RENDERIZAR MODAL] UI de carrinho vazio definida.");
                    return; 
                }

                btnFinalizarPedidoWhatsAppModal.disabled = false;
                carrinhoItensDetalhes.forEach((item, index) => {
                    const itemDiv = document.createElement('div'); itemDiv.classList.add('item-carrinho');
                    const precoTotalItem = item.preco * item.quantidade; subTotalItens += precoTotalItem;
                    itemDiv.innerHTML = `<span class="item-carrinho-nome" title="${item.nome}">${item.nome}</span><div class="item-carrinho-qtd-controle"><button class="btn-qtd" onclick="diminuirQuantidade(${index})">-</button><span class="qtd-valor">${item.quantidade}</span><button class="btn-qtd" onclick="aumentarQuantidade(${index})">+</button></div><span class="item-carrinho-preco">R$ ${formatarPreco(precoTotalItem)}</span><button class="item-carrinho-remover" data-index="${index}" title="Remover ${item.nome}">√ó</button>`;
                    itensCarrinhoListaModalEl.appendChild(itemDiv);
                });

                let valorDescontoFinal = 0;
                if (cupomAplicado) {
                    if (cupomAplicado.tipo === "percentual") valorDescontoFinal = (subTotalItens * cupomAplicado.valor) / 100;
                    else if (cupomAplicado.tipo === "fixo") valorDescontoFinal = cupomAplicado.valor;
                    valorDescontoFinal = Math.min(valorDescontoFinal, subTotalItens); 
                    descontoAplicadoInfoEl.textContent = `Desconto (${cupomAplicado.codigo}): - R$ ${formatarPreco(valorDescontoFinal)}`;
                }
                
                const totalGeral = subTotalItens - valorDescontoFinal;
                console.log("[RENDERIZAR MODAL] Subtotal:", subTotalItens, "Desconto:", valorDescontoFinal, "Total Geral:", totalGeral);
                totalPrecoCarrinhoModalEl.textContent = formatarPreco(totalGeral < 0 ? 0 : totalGeral);
                document.querySelectorAll('#modal-carrinho .item-carrinho-remover').forEach(botao => { botao.addEventListener('click', (event) => { removerItemDoCarrinho(parseInt(event.target.dataset.index)); }); });
            }
            
            function atualizarEsalvarCarrinho() { 
                atualizarContadorCarrinho(); 
                renderizarCarrinhoModal(); 
                salvarDadosClienteNoLocalStorage(); 
            }
            window.aumentarQuantidade = function(index) { carrinhoItensDetalhes[index].quantidade++; itensNoCarrinho++; atualizarEsalvarCarrinho(); }
            window.diminuirQuantidade = function(index) { if (carrinhoItensDetalhes[index].quantidade > 1) { carrinhoItensDetalhes[index].quantidade--; itensNoCarrinho--; atualizarEsalvarCarrinho(); } else { removerItemDoCarrinho(index); } }
            function removerItemDoCarrinho(index) { const itemRemovido = carrinhoItensDetalhes[index]; if (!itemRemovido) return; itensNoCarrinho -= itemRemovido.quantidade; carrinhoItensDetalhes.splice(index, 1); atualizarEsalvarCarrinho(); }
            
            window.limparCarrinhoCompleto = function() {
                if (carrinhoItensDetalhes.length === 0) { mostrarPopup("O carrinho j√° est√° vazio.", "aviso"); return;}
                if (confirm("Tem certeza que deseja limpar todos os itens do carrinho?")) {
                    carrinhoItensDetalhes = []; 
                    itensNoCarrinho = 0; 
                    cupomAplicado = null; 
                    inputCupomEl.value = ''; 
                    cupomFeedbackEl.textContent = ''; 
                    descontoAplicadoInfoEl.textContent = '';
                    
                    atualizarContadorCarrinho(); 
                    renderizarCarrinhoModal(); 
                    salvarDadosClienteNoLocalStorage(); 
                    mostrarPopup("Carrinho limpo com sucesso!", "sucesso");
                }
            }

            produtosEl.forEach(produtoCard => {
                const btnMenos = produtoCard.querySelector('.btn-qtd-produto-menos');
                const btnMais = produtoCard.querySelector('.btn-qtd-produto-mais');
                const inputQtd = produtoCard.querySelector('.input-qtd-produto');
                const precoEl = produtoCard.querySelector('.preco');
                const precoUnitario = parseFloat(produtoCard.dataset.preco);

                function atualizarPrecoCard() {
                    const qtdAtual = parseInt(inputQtd.value);
                    if (precoEl && !isNaN(precoUnitario) && !isNaN(qtdAtual)) {
                        precoEl.textContent = `R$ ${formatarPreco(precoUnitario * qtdAtual)}`;
                    }
                }
                if(precoEl && !isNaN(precoUnitario)){ // Define pre√ßo inicial com base na quantidade 1
                    precoEl.textContent = `R$ ${formatarPreco(precoUnitario * parseInt(inputQtd.value))}`;
                }


                if (btnMenos && btnMais && inputQtd) {
                    btnMenos.addEventListener('click', () => { let qtdAtual = parseInt(inputQtd.value); if (qtdAtual > 1) {inputQtd.value = qtdAtual - 1; atualizarPrecoCard();} });
                    btnMais.addEventListener('click', () => { let qtdAtual = parseInt(inputQtd.value); const maxQtd = parseInt(inputQtd.max) || 99; if (qtdAtual < maxQtd) {inputQtd.value = qtdAtual + 1; atualizarPrecoCard();} });
                }
            });

            botoesAdicionar.forEach(botao => {
                botao.addEventListener('click', (event) => {
                    const produtoDiv = event.target.closest('.produto');
                    const nomeProduto = produtoDiv.dataset.nome;
                    const precoProduto = parseFloat(produtoDiv.dataset.preco); 
                    const inputQtdProdutoEl = produtoDiv.querySelector('.input-qtd-produto');
                    const precoElOriginalDisplay = produtoDiv.querySelector('.preco');
                    const quantidadeSelecionada = parseInt(inputQtdProdutoEl.value);

                    if (isNaN(quantidadeSelecionada) || quantidadeSelecionada < 1) { mostrarPopup("Quantidade inv√°lida.", 'erro'); return; }

                    const produtoExistente = carrinhoItensDetalhes.find(item => item.nome === nomeProduto);
                    if (produtoExistente) produtoExistente.quantidade += quantidadeSelecionada;
                    else carrinhoItensDetalhes.push({ nome: nomeProduto, preco: precoProduto, quantidade: quantidadeSelecionada });
                    
                    itensNoCarrinho += quantidadeSelecionada; 
                    atualizarContadorCarrinho();
                    mostrarPopup(`"${nomeProduto}" (${quantidadeSelecionada}x) adicionado!`);
                    salvarDadosClienteNoLocalStorage();
                    
                    inputQtdProdutoEl.value = 1; 
                    if (precoElOriginalDisplay && !isNaN(precoProduto)) { precoElOriginalDisplay.textContent = `R$ ${formatarPreco(precoProduto)}`;}
                });
            });
            
            botoesCategoria.forEach(botao => { botao.addEventListener('click', () => { botoesCategoria.forEach(btn => btn.classList.remove('active')); botao.classList.add('active'); aplicarFiltrosProdutos(); }); });
            if (inputBuscaProdutoEl) inputBuscaProdutoEl.addEventListener('input', aplicarFiltrosProdutos);
            
            window.validarEPreencherEndereco = async function() {
                const cepClienteInput = cepInputEl.value.replace(/\D/g, ''); cepResultadoEl.textContent = 'Verificando CEP...'; cepResultadoEl.className = ''; enderecoCompletoFormEl.classList.add('escondido');
                if (cepClienteInput.length !== 8) { cepResultadoEl.textContent = 'CEP inv√°lido (8 n√∫meros).'; cepResultadoEl.classList.add('erro'); return; }
                try {
                    const viaCepResponse = await fetch(`https://viacep.com.br/ws/${cepClienteInput}/json/`); if (!viaCepResponse.ok) throw new Error('Falha ao buscar CEP.'); const viaCepData = await viaCepResponse.json();
                    if (viaCepData.erro) { cepResultadoEl.textContent = 'CEP n√£o encontrado.'; cepResultadoEl.classList.add('aviso'); return; }
                    cepResultadoEl.textContent = 'CEP encontrado! Complete o endere√ßo.'; cepResultadoEl.classList.add('sucesso');
                    enderecoRuaEl.value = viaCepData.logradouro || ''; enderecoBairroEl.value = viaCepData.bairro || ''; enderecoCidadeEl.value = viaCepData.localidade || ''; enderecoUfEl.value = viaCepData.uf || '';
                    enderecoNumeroEl.value = ''; enderecoComplementoEl.value = ''; enderecoCompletoFormEl.classList.remove('escondido'); enderecoNumeroEl.focus();
                    enderecoEntregaInfo = null; salvarDadosClienteNoLocalStorage(); 
                } catch (error) { console.error('Erro CEP:', error); cepResultadoEl.textContent = error.message || 'N√£o verificou CEP.'; cepResultadoEl.classList.add('erro'); }
            }
            window.confirmarEnderecoCompleto = function() {
                const nomeCliente = clienteNomeEl.value.trim(); if (!nomeCliente) { alert("Informe seu nome."); clienteNomeEl.focus(); return; }
                const rua = enderecoRuaEl.value.trim(); const numero = enderecoNumeroEl.value.trim(); const complemento = enderecoComplementoEl.value.trim(); const bairro = enderecoBairroEl.value.trim(); const cidade = enderecoCidadeEl.value.trim(); const uf = enderecoUfEl.value.trim(); const cep = cepInputEl.value.replace(/\D/g, '');
                if (!numero) { alert("Informe o n√∫mero."); enderecoNumeroEl.focus(); return; }
                enderecoEntregaInfo = `${rua}, N¬∫ ${numero}`; if (complemento) enderecoEntregaInfo += `, ${complemento}`; enderecoEntregaInfo += `\nBairro: ${bairro}\nCidade: ${cidade} - ${uf}\nCEP: ${cep}`;
                salvarDadosClienteNoLocalStorage(); enderecoConfirmadoMsgEl.textContent = "Nome e endere√ßo confirmados!"; enderecoConfirmadoMsgEl.style.display = 'block'; alert("Nome e endere√ßo confirmados!");
            }
            if (cepInputEl) cepInputEl.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); validarEPreencherEndereco(); } });
            
            function salvarPedidoAtualComoUltimo() {
                if (carrinhoItensDetalhes.length === 0) return;
                let subTotalItens = 0; carrinhoItensDetalhes.forEach(item => subTotalItens += item.preco * item.quantidade);
                let valorDescontoFinal = 0;
                if (cupomAplicado) {
                    if (cupomAplicado.tipo === "percentual") valorDescontoFinal = (subTotalItens * cupomAplicado.valor) / 100;
                    else if (cupomAplicado.tipo === "fixo") valorDescontoFinal = cupomAplicado.valor;
                    valorDescontoFinal = Math.min(valorDescontoFinal, subTotalItens);
                }
                const totalComDesconto = subTotalItens - valorDescontoFinal;
                const pedidoAtual = { id: new Date().getTime(), itens: JSON.parse(JSON.stringify(carrinhoItensDetalhes)), totalPago: totalComDesconto < 0 ? 0 : totalComDesconto, cupomUsado: cupomAplicado ? cupomAplicado.codigo : null, data: new Date().toLocaleDateString('pt-BR'), nomeCliente: clienteNomeEl.value.trim(), endereco: enderecoEntregaInfo };
                ultimosPedidos.unshift(pedidoAtual); 
                if (ultimosPedidos.length > MAX_ULTIMOS_PEDIDOS) ultimosPedidos.pop();
                renderizarUltimosPedidos();
            }

            function renderizarUltimosPedidos() {
                listaUltimosPedidosContainerEl.innerHTML = '';
                if (ultimosPedidos.length === 0) { semPedidosAnterioresEl.style.display = 'block'; return; }
                semPedidosAnterioresEl.style.display = 'none';
                ultimosPedidos.forEach(pedido => {
                    const pedidoDiv = document.createElement('div'); pedidoDiv.classList.add('pedido-anterior');
                    let itensHtml = '<ul class="pedido-anterior-itens">'; pedido.itens.forEach(item => { itensHtml += `<li>${item.nome} (Qtd: ${item.quantidade})</li>`; }); itensHtml += '</ul>';
                    pedidoDiv.innerHTML = `<div class="pedido-anterior-header"><strong>Pedido de ${pedido.data}</strong><span>Total: R$ ${formatarPreco(pedido.totalPago)}</span></div> ${pedido.nomeCliente ? `<p style="font-size:0.9em; margin-bottom:5px;">Cliente: ${pedido.nomeCliente}</p>` : ''} ${itensHtml} <button class="btn-repetir-pedido" data-pedido-id="${pedido.id}">Repetir Pedido</button>`;
                    listaUltimosPedidosContainerEl.appendChild(pedidoDiv);
                });
                document.querySelectorAll('.btn-repetir-pedido').forEach(btn => { btn.addEventListener('click', function() { repetirPedido(parseInt(this.dataset.pedidoId)); }); });
            }
            
            function repetirPedido(pedidoId) {
                const pedidoParaRepetir = ultimosPedidos.find(p => p.id === pedidoId);
                if (!pedidoParaRepetir) { mostrarPopup("Pedido anterior n√£o encontrado.", 'erro'); return; }
                if (!confirm("Isso limpar√° seu carrinho atual e adicionar√° os itens do pedido selecionado. Continuar?")) return;
                carrinhoItensDetalhes = JSON.parse(JSON.stringify(pedidoParaRepetir.itens)); 
                itensNoCarrinho = 0; carrinhoItensDetalhes.forEach(item => { itensNoCarrinho += item.quantidade; });
                if (pedidoParaRepetir.nomeCliente) clienteNomeEl.value = pedidoParaRepetir.nomeCliente;
                if (pedidoParaRepetir.endereco) { enderecoEntregaInfo = pedidoParaRepetir.endereco; enderecoConfirmadoMsgEl.textContent = "Nome e endere√ßo do pedido anterior carregados."; enderecoConfirmadoMsgEl.style.display = 'block'; } 
                else { enderecoEntregaInfo = null; }
                cupomAplicado = null; inputCupomEl.value = ''; cupomFeedbackEl.textContent = ''; descontoAplicadoInfoEl.textContent = '';
                atualizarEsalvarCarrinho();
                mostrarPopup("Itens do pedido anterior adicionados ao carrinho!", 'sucesso');
                abrirModalCarrinho();
            }

            btnFinalizarPedidoWhatsAppModal.addEventListener('click', () => {
                const nomeCliente = clienteNomeEl.value.trim();
                if (!nomeCliente) { alert("Informe seu nome completo."); clienteNomeEl.focus(); return; }
                if (carrinhoItensDetalhes.length === 0) { alert("Carrinho vazio!"); return; }
                if (!enderecoEntregaInfo) { alert("Confirme o endere√ßo."); document.getElementById('cep-section').scrollIntoView({ behavior: 'smooth' }); cepInputEl.focus(); return; }
                
                salvarPedidoAtualComoUltimo(); 

                let mensagem = `üç¶ *Pedido Sorveteria Del√≠cia* üç¶\n\n*Cliente:* ${nomeCliente}\n\nOl√°! Gostaria de fazer o seguinte pedido:\n\n`;
                let subTotalItens = 0; carrinhoItensDetalhes.forEach(item => { subTotalItens += item.preco * item.quantidade; });
                let valorDescontoFinal = 0; let totalComDesconto = subTotalItens;
                if (cupomAplicado) {
                    if (cupomAplicado.tipo === "percentual") valorDescontoFinal = (subTotalItens * cupomAplicado.valor) / 100;
                    else if (cupomAplicado.tipo === "fixo") valorDescontoFinal = cupomAplicado.valor;
                    valorDescontoFinal = Math.min(valorDescontoFinal, subTotalItens); totalComDesconto = subTotalItens - valorDescontoFinal;
                    mensagem += `Subtotal: R$ ${formatarPreco(subTotalItens)}\nDesconto (${cupomAplicado.codigo}): - R$ ${formatarPreco(valorDescontoFinal)}\n`;
                }
                carrinhoItensDetalhes.forEach(item => { mensagem += `*${item.nome}*\n  Qtd: ${item.quantidade}\n  Subtotal Item: R$ ${formatarPreco(item.preco * item.quantidade)}\n\n`; });
                mensagem += `*TOTAL DO PEDIDO: R$ ${formatarPreco(totalComDesconto < 0 ? 0 : totalComDesconto)}*\n\n*ENDERE√áO PARA ENTREGA:*\n${enderecoEntregaInfo}\n\nPor favor, informe a *forma de pagamento*.\nObrigado(a)! üòä`;
                const numeroWhatsApp = "556292714775"; const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensagem)}`; window.open(urlWhatsApp, '_blank');
                
                carrinhoItensDetalhes = []; itensNoCarrinho = 0; cupomAplicado = null; inputCupomEl.value = ''; cupomFeedbackEl.textContent = ''; descontoAplicadoInfoEl.textContent = '';
                atualizarContadorCarrinho(); 
                renderizarCarrinhoModal(); 
                fecharModalCarrinho(); 
                salvarDadosClienteNoLocalStorage();
                mostrarPopup("Pedido enviado para WhatsApp! ‚úÖ");
            });

            if (carrinhoIconHeaderEl) carrinhoIconHeaderEl.addEventListener('click', abrirModalCarrinho);
            carregarDadosDoLocalStorage();
            aplicarFiltrosProdutos();
        });
    </script>
</body>
</html>